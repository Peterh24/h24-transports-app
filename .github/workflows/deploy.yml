name: Deploy H24 Transport App

# Workflow principal qui utilise le workflow r√©utilisable
# Plus simple, plus lisible et plus facile √† maintenir

on:
  push:
    branches:
      - main     # Production
      - develop  # Development

jobs:
  # Job unique pour tous les d√©ploiements (automatique et manuel)
  deploy:
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      dockerfile_path: 'docker/images/nginx/Dockerfile'
      prepare_command: 'npm ci && npm run build'
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}

  # Job optionnel pour les notifications
  notify:
    needs: [deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment notification
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ D√©ploiement r√©ussi!"
            echo "üåç Environnement: ${{ needs.deploy.outputs.environment }}"
            echo "üì¶ Image: ${{ needs.deploy.outputs.image_tag }}"
          else
            echo "‚ùå √âchec du d√©ploiement"
            exit 1
          fi
